<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload and List Zip Files</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Upload an openrocket design file</h1>
    <input type="file" id="zipFileInput" accept=".ork">
    <canvas id="simChart"></canvas>

    <script>
        const parser = new DOMParser();
        
        document.getElementById('zipFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.name.endsWith('.ork')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const arrayBuffer = event.target.result;
                    JSZip.loadAsync(arrayBuffer).then(function(zip) {
                        zip.forEach(function (relativePath, zipEntry) {
                            if (zipEntry.name === 'rocket.ork') {
                                zipEntry.async('string').then(function(content) {
                                    processRocketFile(content)
                                });
                            }
                        });
                    });
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('Please upload a valid .zip file.');
            }
        });

        function processRocketFile(file) {
            const simChart = document.getElementById('simChart');
            
            const doc = parser.parseFromString(file, 'text/xml');
            const openrocket = doc.querySelector('openrocket');
            const rocket = openrocket.querySelector('rocket');
            const sims = openrocket.querySelector('simulations');
            var firstSim = sims.children[0];


            const headers = "Time,Altitude,Vertical velocity,Vertical acceleration,Total velocity,Total acceleration,Position East of launch,Position North of launch,Lateral distance,Lateral direction,Lateral velocity,Lateral acceleration,Latitude,Longitude,Gravitational acceleration,Angle of attack,Roll rate,Pitch rate,Yaw rate,Mass,Motor mass,Longitudinal moment of inertia,Rotational moment of inertia,CP location,CG location,Stability margin calibers,Mach number,Reynolds number,Thrust,Drag force,Drag coefficient,Axial drag coefficient,Friction drag coefficient,Pressure drag coefficient,Base drag coefficient,Normal force coefficient,Pitch moment coefficient,Yaw moment coefficient,Side force coefficient,Roll moment coefficient,Roll forcing coefficient,Roll damping coefficient,Pitch damping coefficient,Coriolis acceleration,Reference length,Reference area,Vertical orientation (zenith),Lateral orientation (azimuth),Wind velocity,Air temperature,Air pressure,Speed of sound,Simulation time step,Computation time".split(",");

            plotSim(firstSim, simChart, headers);            
        }

        function plotSim(sim, chartDom, headers) {
            if (sim.attributes['status'].nodeValue == "uptodate") {
                var flightData = sim.querySelector('flightdata');
                
                const data = flightData.innerHTML.trim().split('\n').map(row => 
                    row.replace(/<\/?datapoint>/g, '').split(',').map(value => parseFloat(value))
                );

                const xLabels = data.map(row => row[0]);
                const datasets = [];

                for (let i = 1; i < data[0].length; i++) {
                    const dataset = {
                        label: `${headers[i]}`,
                        data: data.map(row => row[i]),
                        borderColor: `hsl(${((i - 1) * 360) / (data[0].length - 1)}, 100%, 50%)`,
                        borderWidth: 1
                    };
                    datasets.push(dataset);
                }

                let chart = new Chart(chartDom, {
                    type: 'line',
                    data: {
                        labels: xLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time Sec'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Altitude (km)'
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // This hides all text in the legend and also the labels.
                            }
                        }
                    }
                });

                for (var i=1; i < data[0].length; i++) {
                    chart.setDatasetVisibility(i, false);
                }
                chart.update();
            } else {
                alert("Make sure you ran the simulation and saved with all simulation data");
            }
        }
    </script>
</body>
</html>
